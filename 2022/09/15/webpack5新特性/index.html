<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  <meta name="google-site-verification" content="GUsibHL461s1qz99ZMjNh46oe8yRt65O1CGMHEONTPc" />
  <meta name="baidu-site-verification" content="code-4KLj3Nop3t" />
  
  
  <title>webpack5新特性 | Never</title>
  <meta name="description" content="1 启动命令 webpack4 启动 devServer，用的命令是 webpack-dev-server webpack5 启动 devServer，用的命令是 webpack serve   2 持久化缓存持久化缓存是 webpack5 所带来的非常强大的特性之一。 webpack5 通过将构建结果持久化缓存到本地磁盘，使之在二次构建时可以直接利用磁盘缓存跳过构建过程当中耗时的流程，大大提升编">
<meta property="og:type" content="article">
<meta property="og:title" content="webpack5新特性">
<meta property="og:url" content="https://nevvvver.github.io/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/index.html">
<meta property="og:site_name" content="Never">
<meta property="og:description" content="1 启动命令 webpack4 启动 devServer，用的命令是 webpack-dev-server webpack5 启动 devServer，用的命令是 webpack serve   2 持久化缓存持久化缓存是 webpack5 所带来的非常强大的特性之一。 webpack5 通过将构建结果持久化缓存到本地磁盘，使之在二次构建时可以直接利用磁盘缓存跳过构建过程当中耗时的流程，大大提升编">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://nevvvver.github.io/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220917-180941.png">
<meta property="og:image" content="https://nevvvver.github.io/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220917-182839.png">
<meta property="og:image" content="https://nevvvver.github.io/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220918-023302.png">
<meta property="og:image" content="https://nevvvver.github.io/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220921-143840.png">
<meta property="og:image" content="https://nevvvver.github.io/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220921-144226.png">
<meta property="og:image" content="https://nevvvver.github.io/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220921-144319.png">
<meta property="og:image" content="https://nevvvver.github.io/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220921-163631.png">
<meta property="og:image" content="https://nevvvver.github.io/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220921-163702.png">
<meta property="og:image" content="https://nevvvver.github.io/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220921-163442.png">
<meta property="og:image" content="https://nevvvver.github.io/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220921-154544.png">
<meta property="og:image" content="https://nevvvver.github.io/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220917-233153.png">
<meta property="og:image" content="https://nevvvver.github.io/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220917-194702.png">
<meta property="og:image" content="https://nevvvver.github.io/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220917-194814.png">
<meta property="og:image" content="https://nevvvver.github.io/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220917-200742.png">
<meta property="og:image" content="https://nevvvver.github.io/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220917-195033.png">
<meta property="og:image" content="https://nevvvver.github.io/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220917-195133.png">
<meta property="og:image" content="https://nevvvver.github.io/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220917-223519.png">
<meta property="og:image" content="https://nevvvver.github.io/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220917-193330.png">
<meta property="og:image" content="https://nevvvver.github.io/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220917-193454.png">
<meta property="og:image" content="https://nevvvver.github.io/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220917-195416.png">
<meta property="og:image" content="https://nevvvver.github.io/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220917-195310.png">
<meta property="og:image" content="https://nevvvver.github.io/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220922-231248.png">
<meta property="og:image" content="https://nevvvver.github.io/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220922-231015.png">
<meta property="og:image" content="https://nevvvver.github.io/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220923-113931.png">
<meta property="og:image" content="https://nevvvver.github.io/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220923-151006.png">
<meta property="og:image" content="https://nevvvver.github.io/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220922-190236.png">
<meta property="og:image" content="https://nevvvver.github.io/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220922-165432.png">
<meta property="og:image" content="https://nevvvver.github.io/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220923-020000.png">
<meta property="og:image" content="https://nevvvver.github.io/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220923-020034.png">
<meta property="og:image" content="https://nevvvver.github.io/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220923-114858.png">
<meta property="og:image" content="https://nevvvver.github.io/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220923-014047.png">
<meta property="og:image" content="https://nevvvver.github.io/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220925-175522.png">
<meta property="og:image" content="https://nevvvver.github.io/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220924-205917.png">
<meta property="og:image" content="https://nevvvver.github.io/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220925-044216.png">
<meta property="og:image" content="https://nevvvver.github.io/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220925-044343.png">
<meta property="og:image" content="https://nevvvver.github.io/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220925-041401.png">
<meta property="og:image" content="https://nevvvver.github.io/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220924-211510.png">
<meta property="og:image" content="https://nevvvver.github.io/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220925-203732.png">
<meta property="og:image" content="https://nevvvver.github.io/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220925-203920.png">
<meta property="og:image" content="https://nevvvver.github.io/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220925-174713.png">
<meta property="og:image" content="https://nevvvver.github.io/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220925-194409.png">
<meta property="og:image" content="https://nevvvver.github.io/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220925-195445.png">
<meta property="og:image" content="https://nevvvver.github.io/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220925-195651.png">
<meta property="og:image" content="https://nevvvver.github.io/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220925-200036.png">
<meta property="article:published_time" content="2022-09-15T09:35:49.000Z">
<meta property="article:modified_time" content="2022-10-13T09:41:52.834Z">
<meta property="article:author" content="Never">
<meta property="article:tag" content="webpack5">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://nevvvver.github.io/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220917-180941.png">
  <!-- Canonical links -->
  <link rel="canonical" href="https://nevvvver.github.io/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/index.html">
  
    <link rel="alternate" href="/atom.xml" title="Never" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.jpg" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
<link rel="stylesheet" href="/css/main.css">

  
  
  
  
<meta name="generator" content="Hexo 6.3.0"></head>


<script src="/js/hexo_resize_image.js"></script>
<body class="main-center" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="https://github.com/Nevvvver" target="_blank">
          <img class="img-circle img-rotate" src="/images/avatar.jpg" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">Never</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md">Web Developer &amp; Sunday painter</h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Shanghai, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav menu-highlight">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">分类</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            
            <i class="icon icon-tags"></i>
            
            <span class="menu-title">标签</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/Nevvvver" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="/null" target="_blank" title="Weibo" data-toggle=tooltip data-placement=top><i class="icon icon-weibo"></i></a></li>
        
        <li><a href="/null" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p>欢迎交流与分享经验!</p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">分类</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Books/">Books</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/JavaScript/">JavaScript</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/TypeScript/">TypeScript</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Webpack/">Webpack</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">标签</h3>
    <div class="widget-body">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/es6/" rel="tag">es6</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/javascript/" rel="tag">javascript</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/node/" rel="tag">node</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/webpack5/" rel="tag">webpack5</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">标签云</h3>
    <div class="widget-body tagcloud">
      <a href="/tags/es6/" style="font-size: 13.5px;">es6</a> <a href="/tags/javascript/" style="font-size: 14px;">javascript</a> <a href="/tags/node/" style="font-size: 13px;">node</a> <a href="/tags/webpack5/" style="font-size: 13px;">webpack5</a>
    </div>
  </div>

    
      
  <div class="widget">
    <h3 class="widget-title">归档</h3>
    <div class="widget-body">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">九月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">七月 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">六月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">三月 2022</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Webpack/">Webpack</a>
              </p>
              <p class="item-title">
                <a href="/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/" class="title">webpack5新特性</a>
              </p>
              <p class="item-date">
                <time datetime="2022-09-15T09:35:49.000Z" itemprop="datePublished">2022-09-15</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Books/">Books</a>
              </p>
              <p class="item-title">
                <a href="/2022/07/13/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BANodeJS/" class="title">《深入浅出Node.js》笔记</a>
              </p>
              <p class="item-date">
                <time datetime="2022-07-13T09:35:49.000Z" itemprop="datePublished">2022-07-13</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/Books/">Books</a>
              </p>
              <p class="item-title">
                <a href="/2022/07/11/JavaScript%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97/" class="title">《JavaScript权威指南(第6版)》笔记</a>
              </p>
              <p class="item-date">
                <time datetime="2022-07-11T09:27:54.000Z" itemprop="datePublished">2022-07-11</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/TypeScript/">TypeScript</a>
              </p>
              <p class="item-title">
                <a href="/2022/06/07/jsoneditor-react%E7%9A%84%E7%B1%BB%E5%9E%8B%E5%A3%B0%E6%98%8E%E6%96%87%E4%BB%B6/" class="title">jsoneditor-react的类型声明文件</a>
              </p>
              <p class="item-date">
                <time datetime="2022-06-07T09:25:44.000Z" itemprop="datePublished">2022-06-07</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/JavaScript/">JavaScript</a>
              </p>
              <p class="item-title">
                <a href="/2022/03/15/enumerable/" class="title">可枚举性(enumerable)</a>
              </p>
              <p class="item-date">
                <time datetime="2022-03-14T18:53:58.000Z" itemprop="datePublished">2022-03-15</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
  <aside class="sidebar sidebar-toc collapse   in  " id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">文章目录</h3>
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%90%AF%E5%8A%A8%E5%91%BD%E4%BB%A4"><span class="toc-text">1 启动命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%8C%81%E4%B9%85%E5%8C%96%E7%BC%93%E5%AD%98"><span class="toc-text">2 持久化缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B9%8B%E5%89%8D%E7%9A%84%E6%8C%81%E4%B9%85%E7%BC%93%E5%AD%98%E6%96%B9%E5%BC%8F"><span class="toc-text">之前的持久缓存方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#webpack5-%E7%9A%84%E6%8C%81%E4%B9%85%E7%BC%93%E5%AD%98%E6%96%B9%E5%BC%8F"><span class="toc-text">webpack5 的持久缓存方式</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-text">原理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#cache"><span class="toc-text">cache</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%86%85%E5%AE%B9%E5%93%88%E5%B8%8C%EF%BC%88contentHash%EF%BC%89"><span class="toc-text">内容哈希（contentHash）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#moduleIds-amp-chunkIds-%E7%9A%84%E4%BC%98%E5%8C%96"><span class="toc-text">moduleIds &amp; chunkIds 的优化</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8D%95%E4%B8%AA%E6%A8%A1%E5%9D%97%E7%9A%84%E7%BC%93%E5%AD%98%E5%A4%B1%E6%95%88"><span class="toc-text">单个模块的缓存失效</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E7%BC%93%E5%AD%98%E5%A4%B1%E6%95%88"><span class="toc-text">全局缓存失效</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E7%BB%93%E6%9E%9C%E5%AF%B9%E6%AF%94"><span class="toc-text">构建结果对比</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Webpack4"><span class="toc-text">Webpack4</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Webpack5"><span class="toc-text">Webpack5</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AF%B9%E6%AF%94%E7%BB%93%E6%9E%9C"><span class="toc-text">对比结果</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E8%B5%84%E6%BA%90%E6%A8%A1%E5%9D%97"><span class="toc-text">3 资源模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E6%9B%B4%E6%99%BA%E8%83%BD%E7%9A%84-tree-shaking"><span class="toc-text">4 更智能的 tree shaking</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#webpack4-%E4%B8%AD-Tree-Shaking-%E7%9A%84%E5%B1%80%E9%99%90%E6%80%A7"><span class="toc-text">webpack4 中 Tree Shaking 的局限性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#webpack5-%E7%9A%84-TreeShaking"><span class="toc-text">webpack5 的 TreeShaking</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#usedExports"><span class="toc-text">usedExports</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#sideEffects"><span class="toc-text">sideEffects</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Nested-Tree-Shaking"><span class="toc-text">Nested Tree Shaking</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Inner-Module-Tree-Shaking"><span class="toc-text">Inner Module Tree Shaking</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#CommonJS-Tree-Shaking"><span class="toc-text">CommonJS Tree Shaking</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-nodeJs%E7%9A%84polyfill%E8%84%9A%E6%9C%AC%E8%A2%AB%E7%A7%BB%E9%99%A4"><span class="toc-text">5 nodeJs的polyfill脚本被移除</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E6%A8%A1%E5%9D%97%E8%81%94%E9%82%A6%EF%BC%88Module-Federation%EF%BC%89"><span class="toc-text">6 模块联邦（Module Federation）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E6%93%8D%E6%A1%88%E4%BE%8B%E8%A7%A3%E6%9E%90"><span class="toc-text">实操案例解析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-1"><span class="toc-text">原理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8F%90%E4%BE%9B%E6%96%B9%EF%BC%88remote%EF%BC%89%E6%89%93%E5%8C%85%E5%90%8E%E7%9A%84%E6%96%87%E4%BB%B6"><span class="toc-text">提供方（remote）打包后的文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8F%90%E4%BE%9B%E6%96%B9%EF%BC%88remote%EF%BC%89%E8%BF%9C%E7%A8%8B%E5%85%A5%E5%8F%A3%E6%96%87%E4%BB%B6"><span class="toc-text">提供方（remote）远程入口文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E8%80%85%EF%BC%88host%EF%BC%89%E5%A6%82%E4%BD%95%E5%8A%A0%E8%BD%BD%E8%BF%9C%E7%A8%8B%E5%85%A5%E5%8F%A3%E6%96%87%E4%BB%B6"><span class="toc-text">消费者（host）如何加载远程入口文件</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8E%E5%85%B6%E4%BB%96%E5%85%B1%E4%BA%AB%E4%BB%A3%E7%A0%81%E6%96%B9%E6%A1%88%E6%AF%94%E8%BE%83"><span class="toc-text">与其他共享代码方案比较</span></a></li></ol></li></ol>
    </nav>
  </div>
</aside>

<main class="main" role="main">
  <div class="content">
  <article id="post-webpack5新特性" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      webpack5新特性
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/" class="article-date">
	  <time datetime="2022-09-15T09:35:49.000Z" itemprop="datePublished">2022-09-15</time>
	</a>
</span>
        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/Webpack/">Webpack</a>
  </span>

        
  <span class="article-tag">
    <i class="icon icon-tags"></i>
	<a class="article-tag-link-link" href="/tags/webpack5/" rel="tag">webpack5</a>
  </span>


        

        <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/#comments" class="article-comment-link">评论</a></span>
        
      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <h3 id="1-启动命令"><a href="#1-启动命令" class="headerlink" title="1 启动命令"></a>1 启动命令</h3><ul>
<li>webpack4 启动 devServer，用的命令是 <code>webpack-dev-server</code></li>
<li>webpack5 启动 devServer，用的命令是 <code>webpack serve</code></li>
</ul>
<hr>
<h3 id="2-持久化缓存"><a href="#2-持久化缓存" class="headerlink" title="2 持久化缓存"></a>2 持久化缓存</h3><p>持久化缓存是 webpack5 所带来的非常强大的特性之一。 webpack5 通过将构建结果持久化缓存到本地磁盘，使之在二次构建时可以直接利用磁盘缓存跳过构建过程当中耗时的流程，大大提升编译构建的效率，优化编译流程。</p>
<h4 id="之前的持久缓存方式"><a href="#之前的持久缓存方式" class="headerlink" title="之前的持久缓存方式"></a>之前的持久缓存方式</h4><ul>
<li>使用 cache-loader 可以将上一个 loader 处理的结果写入硬盘缓存（默认在 node_modules&#x2F;.cache&#x2F;cache-loader 目录），webpack 再次构建时如果文件没有发生变化则会直接拉取缓存。但是 cache-loader 缓存是在构建流程当中进行的 只能覆盖由 loader 处理后的文件内容，缓存数据的过程也是有一些性能开销的，也会影响整个的编译构建速度，所以搭配编译耗时较长的 loader 一起使用更划算。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.js$/</span>,</span><br><span class="line">        <span class="attr">use</span>: [<span class="string">&#x27;cache-loader&#x27;</span>, <span class="string">&#x27;babel-loader&#x27;</span>],</span><br><span class="line">        <span class="attr">include</span>: path.<span class="title function_">resolve</span>(<span class="string">&#x27;src&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>还有一部分 loader 自带缓存配置，比如 babel-loader，可以配置参数 cacheDirectory 使用缓存，将每次的编译结果写进磁盘（默认在 node_modules&#x2F;.cache&#x2F;babel-loader 目录）</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.js$/</span>,</span><br><span class="line">        <span class="attr">use</span>: &#123;</span><br><span class="line">            <span class="attr">loader</span>: <span class="string">&#x27;babel-loader&#x27;</span>,</span><br><span class="line">            <span class="attr">cacheDirectory</span>: <span class="literal">true</span>,</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="attr">include</span>: path.<span class="title function_">resolve</span>(<span class="string">&#x27;src&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>terser-webpack-plugin 开启缓存</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    <span class="attr">optimization</span>: &#123;</span><br><span class="line">        <span class="attr">minimizer</span>: [</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">TerserPlugin</span>(&#123;</span><br><span class="line">                <span class="attr">cache</span>: <span class="literal">true</span></span><br><span class="line">            &#125;)</span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>eslint-loader 同样支持缓存功能，只需设置 cache &#x3D; true 即可开启。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    <span class="attr">module</span>: &#123;</span><br><span class="line">        <span class="attr">rules</span>: [&#123;</span><br><span class="line">            <span class="attr">test</span>: <span class="regexp">/\.js$/</span>,</span><br><span class="line">            <span class="attr">exclude</span>: <span class="regexp">/node_modules/</span>,</span><br><span class="line">            <span class="attr">loader</span>: <span class="string">&#x27;eslint-loader&#x27;</span>,</span><br><span class="line">            <span class="attr">options</span>: &#123;</span><br><span class="line">                <span class="attr">cache</span>: <span class="literal">true</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;]</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="webpack5-的持久缓存方式"><a href="#webpack5-的持久缓存方式" class="headerlink" title="webpack5 的持久缓存方式"></a>webpack5 的持久缓存方式</h4><h5 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h5><p>如下图，是 Webpack5 的构建过程，在首次构建完毕后，会将 Module、Chunk、ModuleGraph 等对象序列化后记录到缓存文件中。构建过程中存在许多 CPU 密集型操作，例如调用 Loader 链加载文件时，遇到 babel-loader、eslint-loader、ts-loader 等工具时可能需要重复生成 AST；分析模块依赖信息时则需要遍历 AST，执行大量运算；生成（Seal）阶段也同样存在大量 AST 遍历，以及代码转换、优化操作等等。</p>
<p><img src="/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220917-180941.png"></p>
<p>在下次构建开始时，尝试读入并恢复这些序列化对象的状态，从而跳过执行 Loader 链、解析 AST、解析依赖等耗时操作，提高编译性能。未发生变化的文件就可以跳过编译操作，直接使用缓存副本，减少重复计算；发生变更的模块则重新执行编译流程。缓存执行时机如下图：</p>
<p><img src="/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220917-182839.png"></p>
<h5 id="cache"><a href="#cache" class="headerlink" title="cache"></a>cache</h5><p>cache 在 Webpack 4 中只是单个属性的配置，所对应的值为 true 或 false，而在webpack5增加了许多子配置项。默认不开启。</p>
<p>下面介绍几个 cache 常用的配置项：</p>
<ol>
<li><code>cache.type</code>：缓存类型。支持 ‘memory’ | ‘filesystem’，分别代表基于内存的临时缓存，以及基于文件系统的持久化缓存。在选择 filesystem 的情况下，下面介绍的其他属性生效。</li>
<li><code>cache.cacheDirectory</code>：缓存文件存放的路径。默认目录为 node_modules&#x2F;.cache&#x2F;webpack</li>
<li><code>cache.name</code>：缓存名称。同时也是 cacheDirectory 中的子目录名称，默认值为 webpack 的 <code>$&#123;config.name&#125;-$&#123;config.mode&#125;</code></li>
<li><code>cache.buildDependencies</code>：额外的依赖文件，当这些文件内容发生变化时，缓存会完全失效而执行完整的编译构建，通常可设置为项目配置文件。</li>
<li><code>cache.version</code>：缓存数据的版本。</li>
<li><code>cache.managedPaths</code>：受控目录，Webpack 构建时会跳过新旧代码哈希值与时间戳的对比，直接使用缓存副本，默认值为 [‘.&#x2F;node_modules’]</li>
<li><code>cache.profile</code>：是否输出缓存处理过程的详细日志，默认为 false</li>
<li><code>cache.maxAge</code>：缓存失效时间，默认值为1个月</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="attr">cache</span>: &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&#x27;filesystem&#x27;</span>,<span class="comment">// &#x27;memory&#x27; | &#x27;filesystem&#x27;</span></span><br><span class="line">    <span class="attr">cacheDirectory</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;node_modules/.cache/webpack&#x27;</span>)</span><br><span class="line">    <span class="attr">buildDependencies</span>: &#123;</span><br><span class="line">      <span class="attr">config</span>: [__filename],</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>更多关于 cache 的配置可<a target="_blank" rel="noopener" href="https://webpack.docschina.org/configuration/cache/">前往官网</a></p>
<h5 id="内容哈希（contentHash）"><a href="#内容哈希（contentHash）" class="headerlink" title="内容哈希（contentHash）"></a>内容哈希（contentHash）</h5><p>在 webpack5 里会使用文件内容的真实哈希 <code>[contenthash]</code>，而不是之前的仅仅使用文件内部结构的哈希，这对于长期缓存有着积极的影响，尤其是代码里面只有注释和变量名修改的时候，webpack5 会继续用之前的缓存而不是重新编译。</p>
<p>如下，在 webpack4 中使用 <code>[contenthash]</code> 修改注释后虽然文件内容没变但是却重新编译生成了新的哈希。</p>
<p><img src="/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220918-023302.png"></p>
<p>在 webpack5 中我们对如下文件进行编译，这是第一次生成的<code>[contenthash]</code></p>
<p><img src="/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220921-143840.png"></p>
<p>更改变量名再次编译，可以看到我们的哈希值并没有变化</p>
<p><img src="/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220921-144226.png"><br>修改注释再次编译，可以看到我们的哈希值仍然没有变化</p>
<p><img src="/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220921-144319.png"></p>
<h5 id="moduleIds-amp-chunkIds-的优化"><a href="#moduleIds-amp-chunkIds-的优化" class="headerlink" title="moduleIds &amp; chunkIds 的优化"></a>moduleIds &amp; chunkIds 的优化</h5><p>在 webpack5 之前，没有从 entry 打包的 chunk 文件，都会以1、2、3…的文件命名方式输出，是自增的，删除某些文件可能会导致缓存失效。<br>如下图所示，打包后的文件名1、2、3分别对应 <code>ModuleA</code>、<code>ModuleC</code>、<code>ModuleC</code></p>
<p><img src="/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220921-163631.png"></p>
<p>若我们不引入 <code>ModuleB</code>，你会发现 1、2 分别对应着<code>ModuleA</code>、<code>ModuleC</code>，这是不稳定的。</p>
<p><img src="/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220921-163702.png"></p>
<p>webpack5 新增了长期缓存的算法，在生产模式下是默认启用的。此算法采用确定性的方式将短数字 ID(3 或 4 个字符)短hash值分配给 modules 和 chunks。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">optimization</span>: &#123;</span><br><span class="line">  <span class="attr">chunkIds</span>: <span class="string">&quot;deterministic&quot;</span> </span><br><span class="line">  <span class="attr">moduleIds</span>: <span class="string">&quot;deterministic&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如下图所示，打包后的文件名664、300、761分别对应 <code>ModuleA</code>、<code>ModuleC</code>、<code>ModuleC</code></p>
<p><img src="/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220921-163442.png"></p>
<p>若我们不引入 <code>ModuleB</code>，你会发现 664、761 分别对应着<code>ModuleA</code>、<code>ModuleC</code>，是确定的。</p>
<p><img src="/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220921-154544.png"></p>
<h5 id="单个模块的缓存失效"><a href="#单个模块的缓存失效" class="headerlink" title="单个模块的缓存失效"></a>单个模块的缓存失效</h5><p>Webpack 5 会跟踪每个模块的依赖项：fileDependencies、contextDependencies、missingDependencies。当模块本身或其依赖项发生变更时，Webpack 能找到所有受影响的模块，并重新进行构建处理。</p>
<p>这里需要注意的是，对于 node_modules 中的第三方依赖包中的模块，出于性能考虑，Webpack 不会跟踪具体模块文件的内容和修改时间，而是依据依赖包里package.json 的 name 和 version 字段来判断模块是否发生变更。因此，单纯修改 node_modules 中的模块内容，在构建时不会触发缓存的失效。</p>
<h5 id="全局缓存失效"><a href="#全局缓存失效" class="headerlink" title="全局缓存失效"></a>全局缓存失效</h5><p>当模块代码没有发生变化，但是构建处理过程本身发生变化时（例如升级了 Webpack 版本、修改了配置文件、改变了环境变量等），也可能对构建后的产物代码产生影响。因此在这种情况下不能复用之前缓存的数据，而需要让全局缓存失效，重新构建并生成新的缓存。在 Webpack 5 中共提供了 3 种不同维度的全局缓存失效配置。</p>
<p><strong>1. buildDependencies</strong></p>
<p>第一种配置是 <code>cache.buildDependencies</code>，用于指定可能对构建过程产生影响的依赖项。</p>
<p><code>&#123;defaultWebpack: [&quot;webpack/lib&quot;]&#125;</code>: 默认选项。当 node_modules 中的 Webpack 或 Webpack 的依赖项（例如 watchpack 等）发生变化时，当前的构建缓存即失效。</p>
<p><code>&#123;config: [__filename]&#125;</code>: 它的作用是当配置文件内容或配置文件依赖的模块文件发生变化时，当前的构建缓存即失效。</p>
<p><strong>2. version</strong></p>
<p>第二种配置是 <code>cache.version</code>。当配置文件和代码都没有发生变化，但是构建的外部依赖（如环境变量）发生变化时，预期的构建产物代码也可能不同。这时就可以使用 <code>version</code> 配置来防止在外部依赖不同的情况下混用了相同的缓存。</p>
<p>例如，你的 config 读取环境变量 GIT_REV 并且使用 DefinePlugin 来嵌入打包. 我们就可以将 GIT_REV 作为依赖。可以传入 <code>cache: &#123;version: process.env.GIT_REV&#125;</code>。</p>
<p><strong>3. name</strong></p>
<p>第二种配置是 <code>cache.name</code>。该名称除了作为默认缓存目录下子目录的名称外，也起到区分缓存数据的作用。<br>例如，可以传入 <code>cache: &#123;name: process.env.NODE_ENV&#125;</code>。</p>
<p>需要注意的是: 与 <code>version</code> 或 <code>buildDependencies</code> 等配置不同，<code>name</code> 在默认情况下是作为缓存的子目录名称存在的，因此可以利用 <code>name</code> 保留多套缓存。在 <code>name</code> 切换时，若已存在同名称的缓存，则可以复用之前的缓存。如下，可以通过 <code>name</code> 保存多套缓存。</p>
<p><img src="/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220917-233153.png"></p>
<p>与之相比，当其他配置发生变化时，会直接将之前的缓存失效，即使切换回之前已缓存过的设置，也会当作无缓存处理。</p>
<h4 id="构建结果对比"><a href="#构建结果对比" class="headerlink" title="构建结果对比"></a>构建结果对比</h4><h5 id="Webpack4"><a href="#Webpack4" class="headerlink" title="Webpack4"></a>Webpack4</h5><p>首次编译<br><img src="/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220917-194702.png"></p>
<p>二次编译<br><img src="/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220917-194814.png"></p>
<p>修改 index.js 的一行代码<br><img src="/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220917-200742.png"></p>
<p>devServer 启动<br><img src="/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220917-195033.png"></p>
<p>不关闭 devServer 修改index.js的一行代码</p>
<p><img src="/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220917-195133.png"></p>
<h5 id="Webpack5"><a href="#Webpack5" class="headerlink" title="Webpack5"></a>Webpack5</h5><p>首次编译<br><img src="/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220917-223519.png"></p>
<p>二次编译<br>可以看到第二次编译时一共149个 modules 全部来自缓存<br><img src="/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220917-193330.png"></p>
<p>修改 index.js 的一行代码<br>可以看到除了 index.js 重新构建外，其他的140个 modules 全部来自缓存<br><img src="/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220917-193454.png"></p>
<p>devServer 启动<br><img src="/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220917-195416.png"></p>
<p>不关闭 devServer 修改 index.js 的一行代码<br><img src="/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220917-195310.png"></p>
<h5 id="对比结果"><a href="#对比结果" class="headerlink" title="对比结果"></a>对比结果</h5><table>
<thead>
<tr>
<th>webpack版本</th>
<th>首次编译</th>
<th>无改动二次编译</th>
<th>修改后的二次编译</th>
<th>启动server</th>
<th>修改后的二次编译</th>
</tr>
</thead>
<tbody><tr>
<td>v4</td>
<td>2919ms</td>
<td>1392ms</td>
<td>2467ms</td>
<td>3944ms</td>
<td>2396ms</td>
</tr>
<tr>
<td>v5</td>
<td>3793ms</td>
<td>658ms</td>
<td>1094ms</td>
<td>2500ms</td>
<td>72ms</td>
</tr>
</tbody></table>
<p>webpack5 相对于 webpack4，首次构建速度的会慢一些，因为 webpack5 还需要进行缓存相关的操作。但是我们可以看到在无修改的二次编译时 webpack5 相较于 webpack4 速度大大提升，快了近52%。在 devServer 中的增量编译效果更明显，快了近97%，因为 server 在启动后的编译无需再初始化了（如 loader、plugin 的初始化），所以速度更快。我进行这个实验的代码量很少，相信在庞大的项目中还会有更好的效果。</p>
<hr>
<h3 id="3-资源模块"><a href="#3-资源模块" class="headerlink" title="3 资源模块"></a>3 资源模块</h3><p>资源模块是一种模块类型，Webpack5 提供了内置的静态资源（图片、字体、图标等）构建能力，我们不需要安装额外的 loader，仅需要简单的配置就能实现静态资源的打包和分目录存放。</p>
<p>在 Webpack5 之前，我们一般都会使用以下几个 loader 来处理一些常见的静态资源：</p>
<ul>
<li><code>raw-loader</code>：将文件导入为字符串。</li>
<li><code>file-loader</code>：将文件打包导到输出目录，并在 import 的时候返回一个文件的 URI 将文件作为 data URI 内联到 bundle 中。</li>
<li><code>url-loader</code>：当文件大小达到一定要求的时候，可以将其处理成 base64 的 URIS ，内置 file-loader，将文件发送到输出目录。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [&#123;</span><br><span class="line">      <span class="attr">test</span>: <span class="regexp">/\.(png|gif|jpe?g)$/i</span>,</span><br><span class="line">      <span class="attr">use</span>: &#123;</span><br><span class="line">        <span class="comment">// loader: &#x27;file-loader&#x27;,</span></span><br><span class="line">        <span class="attr">loader</span>: <span class="string">&#x27;url-loader&#x27;</span>,</span><br><span class="line">        <span class="attr">options</span>: &#123;</span><br><span class="line">          <span class="comment">// 指定图片大小，小于该数值的图片，会被转成 base64</span></span><br><span class="line">          <span class="attr">limit</span>: <span class="number">8</span> * <span class="number">1024</span>, <span class="comment">// 8kb</span></span><br><span class="line">          <span class="attr">name</span>: <span class="string">&#x27;image/[name].[ext]&#x27;</span>,</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>资源模块类型(asset module type)，通过添加 4 种新的模块类型，来替换所有这些 loader：</p>
<ul>
<li><code>asset/resource</code> 发送一个单独的文件并导出URL。之前通过使用 file-loader 实现。</li>
<li><code>asset/inline</code> 导出一个资源的 data URI。之前通过使用 url-loader 实现。</li>
<li><code>asset/source</code> 导出资源的源代码。之前通过使用 raw-loader 实现。</li>
<li><code>asset</code> 可以在导出一个 data URI 和 发送一个单独的文件之间自动选择，可以通过parser配置资源体积限制。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [&#123;</span><br><span class="line">      <span class="attr">test</span>: <span class="regexp">/\.(png|gif|jpe?g)$/i</span>,</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;asset&#x27;</span>,  </span><br><span class="line">      <span class="comment">// 现在，webpack 将按照默认条件，自动地在 resource 和 inline 之间进行选择：</span></span><br><span class="line">      <span class="comment">// 小于 8kb 的文件，将会视为 inline 模块类型，否则会被视为 resource 模块类型。</span></span><br><span class="line">      <span class="comment">// 自定义设置</span></span><br><span class="line">      <span class="attr">parser</span>: &#123;</span><br><span class="line">        <span class="attr">dataUrlCondition</span>: &#123;</span><br><span class="line">          <span class="attr">maxSize</span>: <span class="number">8</span> * <span class="number">1024</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">generator</span>: &#123;</span><br><span class="line">        <span class="comment">// 该[ext]已经包含了一个点</span></span><br><span class="line">        <span class="attr">filename</span>: <span class="string">&#x27;image/[name][ext]&#x27;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另外 webpack 输出的 data URI 默认是使用 base64 算法编码的文件内容，如果要使用自定义编码算法，可以指定一个自定义函数来编码文件的内容，如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> svgToMiniDataURI = <span class="built_in">require</span>(<span class="string">&#x27;mini-svg-data-uri&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [&#123;</span><br><span class="line">      <span class="attr">test</span>:<span class="regexp">/\.svg/</span>,</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;asset/inline&#x27;</span>,</span><br><span class="line">      <span class="attr">generator</span>: &#123;</span><br><span class="line">        <span class="attr">dataUrl</span>: <span class="function"><span class="params">content</span> =&gt;</span> &#123;</span><br><span class="line">          content = content.<span class="title function_">toString</span>();</span><br><span class="line">          <span class="keyword">return</span> <span class="title function_">svgToMiniDataURI</span>(content);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;]</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>更多关于资源模块的配置可<a target="_blank" rel="noopener" href="https://webpack.docschina.org/guides/asset-modules/">前往官网</a></p>
<hr>
<h3 id="4-更智能的-tree-shaking"><a href="#4-更智能的-tree-shaking" class="headerlink" title="4 更智能的 tree shaking"></a>4 更智能的 tree shaking</h3><p>Tree Shaking 通常用于描述移除 JavaScript 上下文中的未引用代码 (dead-code)。以达到减小体积，缩短 http 请求时间，起到一定效果的页面优化。</p>
<h4 id="webpack4-中-Tree-Shaking-的局限性"><a href="#webpack4-中-Tree-Shaking-的局限性" class="headerlink" title="webpack4 中 Tree Shaking 的局限性"></a>webpack4 中 Tree Shaking 的局限性</h4><ul>
<li><p>引入的模块需要是 ES6 类型的，CommonJS 类型的则不支持。</p>
</li>
<li><p>引入方式不能使用 <code>default</code>。<code>export default</code> 会导致 Tree Shaking 失败，简单来说就是 <code>export default</code> 打包后会作为一个对象整体。webpack 只会分析顶层对象的使用情况，并不会分析对象中的属性，所以 <code>export default</code> 要么就是整体引入，要么就是整体删除。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ./src/inner_module.js</span></span><br><span class="line"><span class="keyword">const</span> a = <span class="string">&#x27;inner_a&#x27;</span></span><br><span class="line"><span class="keyword">const</span> b = <span class="string">&#x27;inner_b&#x27;</span></span><br><span class="line"><span class="keyword">export</span> &#123; a , b &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ./src/index.js</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> inner <span class="keyword">from</span> <span class="string">&#x27;./inner-module&#x27;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(inner.<span class="property">b</span>)</span><br></pre></td></tr></table></figure>
<p><img src="/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220922-231248.png"><br>没有使用 <code>export default</code>，可以正常进行 Tree Shaking，产物中只剩下 <code>inner_b</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ./src/inner_module.js</span></span><br><span class="line"><span class="keyword">const</span> a = <span class="string">&#x27;inner_a&#x27;</span></span><br><span class="line"><span class="keyword">const</span> b = <span class="string">&#x27;inner_b&#x27;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123; a , b &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ./src/index.js</span></span><br><span class="line"><span class="keyword">import</span> inner <span class="keyword">from</span> <span class="string">&#x27;./inner-module&#x27;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(inner.<span class="property">b</span>)</span><br></pre></td></tr></table></figure>
<p><img src="/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220922-231015.png"><br>使用 <code>export default</code>后，Tree Shaking 失效，产物中留下了 <code>inner_a</code>、<code>inner_b</code>。</p>
</li>
<li><p>webpack4 主要是找 <code>import</code> 进来的变量是否在这个模块内出现过，出现过的不剔除，剔除没出现过的。这种方式往往作用不大，因为一般不会去 <code>import</code> 一个没有用到的变量。现在的编辑器和 lint 工具都会提示你去删掉无用的变量。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ./index.js（入口文件）</span></span><br><span class="line"><span class="keyword">import</span> &#123; cube &#125; <span class="keyword">from</span> <span class="string">&#x27;./math&#x27;</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">cube</span>(<span class="number">2</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// ./math.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; pow &#125; <span class="keyword">from</span> <span class="string">&#x27;./utils&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">square</span>(<span class="params">x</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">pow</span>(x);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">cube</span>(<span class="params">x</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> x * x * x;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ./utils.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">pow</span>(<span class="params">x</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> x * x;</span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">plus</span>(<span class="params">x, y</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> x + y;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220923-113931.png"><br>以上是对应的依赖关系图和打包后的产物，根据 <code>import</code> 进来的变量是否在这个模块内出现过的原理分析，这里 <code>cube</code> 在 <code>./index</code> 中被用到，会被打包。而 <code>pow</code> 在 <code>./math.js</code> 中被用到，也会被打包。但实际上从入口 <code>./index.js</code> 来看的话，<code>pow</code> 并不需要，因为依赖 <code>pow</code> 的 <code>square</code> 并没有被用到。但是 webpack 并不知道这一点，因为它没有做相应的作用域分析，去判断模块中导出内容与导入内容间的连接关系。</p>
</li>
<li><p>引用第三方依赖包的情况下，对应的 package.json 需要设置 <code>sideEffects: false</code> 来表明无副作用。webpack4 默认地将所有代码视为有副作用，这可以保护你免于删除必要的文件，但这意味着 webpack4 的默认行为实际上是不进行  Tree Shaking。</p>
</li>
</ul>
<h4 id="webpack5-的-TreeShaking"><a href="#webpack5-的-TreeShaking" class="headerlink" title="webpack5 的 TreeShaking"></a>webpack5 的 TreeShaking</h4><p>webpack5 的 Tree Shaking 更精细化，可以根据作用域之间的关系来进行优化，分析模块的引用关系。直接分析到哪些变量有效地用到了，就打包哪些变量。</p>
<h5 id="usedExports"><a href="#usedExports" class="headerlink" title="usedExports"></a>usedExports</h5><p>在 Webpack5 中，Tree Shaking 在生产环境下默认启动（<code>usedExports</code> + <code>Terser</code>）。</p>
<p>如果想在开发环境启动 Tree Shaking，需要如下配置：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">optimization</span>: &#123;</span><br><span class="line">  usedExports : <span class="literal">true</span> <span class="comment">// 标记出未被导出的变量 &quot;unused harmony export&quot;</span></span><br><span class="line">  minimize : <span class="literal">true</span> <span class="comment">// 去除无用变量并压缩代码</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 默认使用 Terser 进行压缩，也允许你定制自己的压缩工具</span></span><br><span class="line">  <span class="comment">// minimize = true 时，配置才生效</span></span><br><span class="line">  <span class="attr">minimizer</span>: [<span class="keyword">new</span> <span class="title class_">TerserPlugin</span>()] </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>usedExports</code> 用于在 webpack 编译过程中启动标记功能，它会将每个模块中没有被使用过的导出内容标记为 unused，然后配合 Terser 将没用的函数在打包的时候删掉（会删除导出语句和这个模块）。可以说，真正执行 Tree Shaking 操作的是 Terser 插件。webpack5 内置了 terser-webpack-plugin 插件，无需自己安装。</p>
<p><img src="/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220923-151006.png"></p>
<h5 id="sideEffects"><a href="#sideEffects" class="headerlink" title="sideEffects"></a>sideEffects</h5><p>导出后没有使用，只是做了一个 <code>import</code>，那么这个 <code>import</code> 是没意义的，所以这个 <code>import</code> 语句 和 <code>import</code> 的文件都应该被去掉，这就要用到 <code>sideEffects</code>。</p>
<p>side effect（副作用）指当调用函数时，除了返回函数值之外，还产生了附加的影响（例如修改全局变量等），不能仅仅通过 <code>export</code> 判断有无意义。因此实现 Tree shaking 还有一个方式是跳过整个模块&#x2F;文件，直接查看该文件是否有副作用。<code>sideEffects</code> 就是用于告知 webpack 哪些模块具有副作用。</p>
<p><code>sideEffects</code> 可配置在 package.json 和 webpack 中</p>
<ul>
<li><p>在 webpack 中配置<br>表示是否开启副作用功能。告知 webpack 去辨识 package.json 中的副作用标记或规则，以去掉那些导出不被使用且被标记不包含副作用的模块。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">optimization</span>: &#123;</span><br><span class="line">  <span class="comment">// 以下配置可以开启副作用功能 </span></span><br><span class="line">  <span class="comment">// 在开发模式下默认关闭（生产模式默认开启）</span></span><br><span class="line">  <span class="attr">sideEffects</span>: <span class="literal">true</span> <span class="comment">// true | false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
<li><p>在 package.json 中配置<br><code>true</code>：（默认值）这意味着所有的文件都有副作用，没有一个文件可以 Tree shaking。<br><code>false</code>：告诉 Webpack 所有文件都没有副作用，所有文件都可以 Tree shaking。<br><code>数组</code>：除了数组中包含的文件外，其他任何文件都没有副作用。除了指定的文件之外，其他文件都可以安全地进行 Tree shaking。</p>
</li>
</ul>
<p>例如全局 css 样式，<code>import</code> 了但没有使用，若设置了 <code>sideEffect: false</code> 就会被认为没有副作用且被删掉，所以我们可以配置  <code>sideEffect: [&quot;**.css&quot;]</code></p>
<p>要设置 css 文件有副作用还可以在 webpack 里的 loader 中进行配置，如下代码就可以指定所有的 css 都是有副作用的。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">module</span>: &#123;</span><br><span class="line">  <span class="attr">rules</span>: [&#123;</span><br><span class="line">    <span class="attr">test</span>: <span class="regexp">/\.css$/i</span>,</span><br><span class="line">    <span class="attr">use</span>:[],</span><br><span class="line">    <span class="attr">sideEffects</span>: <span class="literal">true</span></span><br><span class="line">  &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h5 id="Nested-Tree-Shaking"><a href="#Nested-Tree-Shaking" class="headerlink" title="Nested Tree Shaking"></a>Nested Tree Shaking</h5><p>webpack5 增加了对嵌套模块的导出跟踪功能，能够找到那些嵌套在最内层而未被使用的模块属性。例如下面的示例代码，webpack5 能够跟踪对导出的嵌套属性的访问，因此可以改善重新导出命名空间对象时的 Tree Shaking。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//./src/inner-module.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> a = <span class="string">&#x27;inner_a&#x27;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> b = <span class="string">&#x27;inner_b&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//.src/nested-module.js</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> inner <span class="keyword">from</span> <span class="string">&#x27;./inner-module&#x27;</span></span><br><span class="line"><span class="keyword">const</span> nested = <span class="string">&#x27;nested&#x27;</span></span><br><span class="line"><span class="keyword">export</span> &#123; inner, nested &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//./src/index.js</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> nested <span class="keyword">from</span> <span class="string">&#x27;./nested-module&#x27;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(nested.<span class="property">inner</span>.<span class="property">a</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220922-190236.png"></p>
<p>这是在 webpack4 生产环境执行的构建，可以看到 <code>inner_a</code>、<code>inner_b</code> 都被保留了，这是因为在 nested-module 中，他们作为一个整体被 <code>import</code> ，且被使用了（被<code> export</code> 了）。</p>
<p><img src="/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220922-165432.png"></p>
<p>这是在 webpack5 生产环境执行的构建，在构建后的结果代码中只包含了引用的内部模块的一个属性 <code>inner_a</code>，而忽略了不被引用的内部模块和中间模块的其他属性。</p>
<h5 id="Inner-Module-Tree-Shaking"><a href="#Inner-Module-Tree-Shaking" class="headerlink" title="Inner Module Tree Shaking"></a>Inner Module Tree Shaking</h5><p>除了上面对嵌套引用模块的依赖分析优化外，webpack5 中还增加了分析模块中导出项与导入项的依赖关系的功能，即上面提到的作用域分析，从而找到更多未被使用的导入模块并加以移除。通过选项 <code>optimization.innerGraph</code> 进行配置，该选项在生产环境下默认开启，在开发环境下默认关闭。</p>
<p>在 webpack5 开发环境下构建下面的示例代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//./src/inner-module.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> a = <span class="string">&#x27;inner_a&#x27;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> b = <span class="string">&#x27;inner_b&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//.src/nested-module.js</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> inner <span class="keyword">from</span> <span class="string">&#x27;./inner-module&#x27;</span></span><br><span class="line"><span class="keyword">const</span> nested = <span class="string">&#x27;nested&#x27;</span></span><br><span class="line"><span class="keyword">export</span> &#123; inner, nested &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 增加下面代码</span></span><br><span class="line"><span class="keyword">const</span> useB = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> inner.<span class="property">b</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> usingB = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">useB</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//./src/index.js</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> nested <span class="keyword">from</span> <span class="string">&#x27;./nested-module&#x27;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(nested.<span class="property">inner</span>.<span class="property">a</span>)</span><br></pre></td></tr></table></figure>

<p><code>optimization.usedExports = true</code><br><code>optimization.innerGraph = false</code>（默认）<br><code>optimization.minimize = true</code></p>
<p><img src="/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220923-020000.png"></p>
<p><code>optimization.usedExports = true</code><br><code>optimization.innerGraph = true</code><br><code>optimization.minimize = true</code></p>
<p><img src="/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220923-020034.png"></p>
<p>当我们在 nested-module.js 中新增了导出项 <code>usingB</code>，该导出项间接依赖导入项 <code>inner.b</code>，而这一导出项在入口模块中并未使用。在关闭 <code>innerGraph</code> 的情况下，构建后会发现间接引用的导出项没有被移除，该导出项间接引用的 <code>inner.b</code> 也被保留到了产物代码中。但是如果将优化项 <code>innerGraph</code> 开启，构建完成后只保留真正被使用的 <code>inner.a</code>。</p>
<p><img src="/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220923-114858.png"></p>
<p>它从入口遍历所有模块形成依赖图，并将它们捆绑在一起（bundles）。同时，webpack 知道那些导出被使用。不如我们遍历所有的作用域并将其进行分析，消除未使用的范围和模块的方法。事实上，我们可以把 scope 看作是图中的一个节点。</p>
<p>将上面的代码在 webpack5 中打包，square 和 pow 相关，但如果 square 不会由另一个模块导入，那么 square 连同 pow 都会被消除，可以看到在产物中 <code>pow</code> 和 <code>plus</code>都被标记为 unused。</p>
<h5 id="CommonJS-Tree-Shaking"><a href="#CommonJS-Tree-Shaking" class="headerlink" title="CommonJS Tree Shaking"></a>CommonJS Tree Shaking</h5><p>webpack5 中增加了对一些 CommonJS 风格模块代码的静态分析功功能：</p>
<ul>
<li>支持 <code>exports.xxx</code>、<code>this.exports.xxx</code>、<code>module.exports.xxx</code> 语法的导出分析。</li>
<li>支持 <code>Object.defineProperty(exports, &quot;xxxx&quot;, ...)</code> 语法的导出分析。</li>
<li>支持 <code>require(&#39;xxxx&#39;).xxx</code> 语法的导入分析。</li>
</ul>
<p>例如下面的代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//./src/module.js</span></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">a</span> = <span class="number">11</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">exports</span>.<span class="property">b</span> = <span class="number">22</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span>.<span class="property">c</span> = <span class="number">33</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;module&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//./src/index.js</span></span><br><span class="line"><span class="keyword">const</span> a = <span class="built_in">require</span>(<span class="string">&#x27;./module&#x27;</span>).<span class="property">a</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220923-014047.png"></p>
<p>可以看到产物代码中只有被引入的属性 <code>a</code> 和 <code>console</code> 语句，而其他两个导出属性 <code>b</code> 和 <code>c</code> 已经在产物中被排除了。</p>
<hr>
<h3 id="5-nodeJs的polyfill脚本被移除"><a href="#5-nodeJs的polyfill脚本被移除" class="headerlink" title="5 nodeJs的polyfill脚本被移除"></a>5 nodeJs的polyfill脚本被移除</h3><p>webpack5 以前，webpack 会包含 nodejs 核心模块的 polyfill，这样的话，比如安装了一个crypto模块，那么就可以直接使用，因为 node 的polyfill会自动启动。</p>
<p>现在 webpack5 不再为 Node.js 模块自动引用 Polyfills（Polyfills是一个语法检查的模版工具），需要手动添加适合的 Polyfills。</p>
<p>如果你想要使用类似 crypto 的 nodejs 核心模块，那么可以在 webpack 配置文件的 <code>resolve</code> 中配置 <code>fallback</code>，配置了就可以使用了，如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="attr">resolve</span>: &#123;</span><br><span class="line">        <span class="attr">fallback</span>:  &#123;</span><br><span class="line">            <span class="comment">// 如果不需要，直接改为 false 就可以了</span></span><br><span class="line">            <span class="string">&quot;crypto&quot;</span>: <span class="built_in">require</span>.<span class="title function_">resolve</span>(<span class="string">&quot;crypto-browserify&quot;</span>), </span><br><span class="line">            <span class="string">&quot;buffer&quot;</span>: <span class="built_in">require</span>.<span class="title function_">resolve</span>(<span class="string">&quot;buffer&quot;</span>),</span><br><span class="line">            <span class="string">&quot;stream&quot;</span>:<span class="built_in">require</span>.<span class="title function_">resolve</span>(<span class="string">&quot;stream-browserify&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="6-模块联邦（Module-Federation）"><a href="#6-模块联邦（Module-Federation）" class="headerlink" title="6 模块联邦（Module Federation）"></a>6 模块联邦（Module Federation）</h3><p><a target="_blank" rel="noopener" href="https://webpack.docschina.org/concepts/module-federation/">https://webpack.docschina.org/concepts/module-federation/</a><br>模块联邦是 webpack5 新内置的一个重要功能，它允许多个 webpack 一起工作，可以让跨应用间真正做到模块共享。解决了独立应用之间代码共享问题，能在项目内动态加载其他项目的代码，因此每个项目可以单独开发和部署它们。</p>
<p>模块联邦本身是一个普通的 webpack 插件 ModuleFederationPlugin，这个插件有几个重要参数：<br><code>name</code> 当前应用名称。（供调用方使用）<br><code>filename</code> 打包后的文件名称。（供调用方使用）<br><code>exposes</code> 表示导出的模块，只有在此申明的模块才可以作为远程依赖被使用。（暴露模块）<br><code>remotes</code> 导入模块，可以将其他项目的 name 映射到当前项目中。（模块使用方）<br><code>shared</code> 是非常重要的参数，可以配置共享的组件，一般是对第三方库做共享使用。如果配置了这个属性。webpack 在加载的时候会先判断本地应用是否存在对应的包，如果不存在，则加载远程应用的依赖包。</p>
<p><img src="/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220925-175522.png"></p>
<h4 id="实操案例解析"><a href="#实操案例解析" class="headerlink" title="实操案例解析"></a>实操案例解析</h4><p>我们先创建两个应用 app1、app2：我们让 app1 作为模块提供方（remote），而 app2 就作为模块的消费方（host）。</p>
<p>并导出，在app2中分别引入app1的这两个组件。</p>
<p><strong>app1</strong></p>
<p>在 app1 中定义两个组件 <code>sitename</code> 和 <code>info</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ./src/index.js</span></span><br><span class="line"><span class="keyword">import</span> sitename <span class="keyword">from</span> <span class="string">&#x27;./sitename&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> title = <span class="title function_">siteName</span>(<span class="string">&#x27;APP1&#x27;</span>);</span><br><span class="line"><span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">append</span>(title);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ./src/sitename.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> (name) =&gt; &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;来自App1的模块：sitename&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> ele = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;h3&#x27;</span>);</span><br><span class="line">  ele.<span class="property">textContent</span> = name;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> ele;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ./src/info.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> () =&gt; &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;来自App1的模块：info&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> ele = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;h3&#x27;</span>);</span><br><span class="line">    ele.<span class="property">textContent</span> = <span class="string">&#x27;模块联邦是 webpack5 新内置的一个重要功能，</span></span><br><span class="line"><span class="string">    它允许多个 webpack 一起工作，可以让跨应用间真正做到模块共享。&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ele;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建 webpack.config.js 文件，将 <code>sitename</code> 和 <code>info</code> 暴露出去，以便提供给消费方使用，配置文件如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Mfp</span> = <span class="built_in">require</span>(<span class="string">&#x27;webpack&#x27;</span>).<span class="property">container</span>.<span class="property">ModuleFederationPlugin</span>;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// 开发服务器</span></span><br><span class="line">  <span class="attr">devServer</span>: &#123;</span><br><span class="line">    <span class="attr">static</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;output&#x27;</span>),</span><br><span class="line">    <span class="attr">port</span>: <span class="number">8800</span>,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Mfp</span>(&#123;</span><br><span class="line">      <span class="comment">// 应用名称（给调用方使用）</span></span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;app1_remote&#x27;</span>,</span><br><span class="line">      <span class="comment">// 调用方引入的文件名称</span></span><br><span class="line">      <span class="attr">filename</span>: <span class="string">&#x27;app1.js&#x27;</span>,</span><br><span class="line">      <span class="comment">// 暴露模块</span></span><br><span class="line">      <span class="attr">exposes</span>: &#123;</span><br><span class="line">        <span class="comment">// 模块名称：模块文件路径</span></span><br><span class="line">        <span class="string">&#x27;./sitename&#x27;</span>: <span class="string">&#x27;./src/sitename.js&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;./info&#x27;</span>: <span class="string">&#x27;./src/info.js&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p><strong>app2</strong></p>
<p>创建 webpack.config.js 文件，在 remotes 中引入 app1 中的模块 app1_remote：<code>app1_remote@http://localhost:8800/app1.js</code>，app1_remote 需要和 app1 中配置的 name 一致，这个是唯一标识。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line"><span class="comment">// 开发服务器</span></span><br><span class="line"><span class="attr">devServer</span>: &#123;</span><br><span class="line">  <span class="attr">static</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;output&#x27;</span>),</span><br><span class="line">  <span class="attr">port</span>: <span class="number">8801</span>,</span><br><span class="line">&#125;,</span><br><span class="line"><span class="comment">// 插件配置</span></span><br><span class="line"><span class="attr">plugins</span>: [</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">Mfp</span>(&#123;</span><br><span class="line">    <span class="comment">// 导入模块</span></span><br><span class="line">    <span class="attr">remotes</span>: &#123;</span><br><span class="line">      <span class="comment">// 导入别名: 远程应用名称@远程应用地址/远程导出文件的名称</span></span><br><span class="line">      <span class="attr">appone</span>: <span class="string">&quot;app1_remote@http://localhost:8800/app1.js&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 app2 中异步引入这两个组件 <code>sitename</code> 和 <code>info</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ./src/index.js</span></span><br><span class="line"><span class="title function_">import</span>(<span class="string">&#x27;appone/sitename&#x27;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> title = res.<span class="title function_">default</span>(<span class="string">&#x27;在APP2中用sitename创建的&#x27;</span>);</span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">append</span>(title);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="title function_">import</span>(<span class="string">&#x27;appone/info&#x27;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> title = res.<span class="title function_">default</span>();</span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">append</span>(title);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后我们分别启动这两个应用：<br><img src="/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220924-205917.png"></p>
<p>app1的页面<br><img src="/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220925-044216.png"><br>app2的页面<br><img src="/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220925-044343.png"><br><img src="/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220925-041401.png"></p>
<p>热插拔：在不关闭 server 的情况下 我们在 app1 中改动 <code>sitename</code> 模块中的内容。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ./src/sitename.js</span></span><br><span class="line">...</span><br><span class="line">ele.<span class="property">textContent</span> = name + <span class="string">&#x27;我改动了&#x27;</span>;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>然后刷新 app2 的页面会发现页面已经及时更新了。<br><img src="/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220924-211510.png"></p>
<p><strong>公共库的提取</strong></p>
<p>首先我们在 app1 的 <code>sitename</code> 组件中使用 <code>jquery</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ./src/sitename.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> (name) =&gt; &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;来自App1的模块：sitename&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> ele = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;h3&#x27;</span>);</span><br><span class="line">    ele.<span class="property">textContent</span> = name;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加入下面代码</span></span><br><span class="line">    <span class="title function_">import</span>(<span class="string">&#x27;jquery&#x27;</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>)=&gt;</span>&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ele;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 app2 中也使用 <code>jquery</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="comment">// ./src/index.js</span></span><br><span class="line"><span class="comment">// 加入下面代码</span></span><br><span class="line"><span class="title function_">import</span>(<span class="string">&#x27;jquery&#x27;</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>可以看到 <code>jquery</code> 加载了两次，分别在本地 :8801 和远程 <code>sitename</code> 模块中使用的 :8800 也加载了一次。</p>
<p><img src="/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220925-203732.png"></p>
<p>在 app1 和 app 中的都加入如下 <code>shared</code> 配置，然后关闭 server 重新启动。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">Mfp</span>(&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="attr">shared</span>: &#123;</span><br><span class="line">    <span class="attr">jquery</span>: &#123;</span><br><span class="line">      <span class="attr">requiredVersion</span>: <span class="string">&#x27;^3.6.1&#x27;</span>,</span><br><span class="line">      <span class="attr">singleton</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><img src="/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220925-203920.png"></p>
<p>可以看到此时 <code>jquery</code> 只加载一次且加载的是本地的 <code>jquery</code>（:8801）而不是远程模块的。</p>
<h4 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a>原理</h4><h5 id="提供方（remote）打包后的文件"><a href="#提供方（remote）打包后的文件" class="headerlink" title="提供方（remote）打包后的文件"></a>提供方（remote）打包后的文件</h5><p>接下来我们来看提供方（remote），也就是 app1 打包后的文件列表：</p>
<p><img src="/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220925-174713.png"></p>
<ul>
<li><code>app.js</code> 是远程入口文件，其他 webpack 构建使用、访问本项目暴露的模块时，须通过它来加载。</li>
<li><code>main.js</code> 是本项目的入口文件。</li>
<li><code>src_info_js.js</code> 和 <code>src_sitename_js.js</code> 是暴露的模块，供其他项目消费。</li>
</ul>
<h5 id="提供方（remote）远程入口文件"><a href="#提供方（remote）远程入口文件" class="headerlink" title="提供方（remote）远程入口文件"></a>提供方（remote）远程入口文件</h5><p>提供方（remote）的统一访问入口文件 <code>app1.js</code> 负责维护管理加载共享模块。</p>
<p>当我们在消费方（host）执行 <code>import(&#39;appone/sitename&#39;)</code> 时，app2 会载入这个文件然后引入 <code>sitename</code> 组件。 <code>container.get(./sitenname)</code> 会从 <code>__webpack_modules__</code> 里面拿到加载组件的方法，执行 <code>webpack_require.e</code>，并返回 promise。<br>具体源码如下：</p>
<p><img src="/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220925-194409.png"></p>
<p><code>moduleMap</code> 是具体业务组件以及对应组件的加载策略。<br><code>get</code> 外部应用调用 get 方法加载具体业务组件。<br><code>init</code> 处理全局依赖共享的问题，处理共享模块的全局依赖，比如 <code>jquery</code> 模块。</p>
<h5 id="消费者（host）如何加载远程入口文件"><a href="#消费者（host）如何加载远程入口文件" class="headerlink" title="消费者（host）如何加载远程入口文件"></a>消费者（host）如何加载远程入口文件</h5><p>app2 如何载入 app1 的 app1.js<br><code>import(&#39;appone/sitename&#39;)</code> 在 app2 打包后会编译成如下代码：</p>
<p><img src="/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220925-195445.png"></p>
<p><code>webpack_require.e</code> 作为加载远程 chunk 的方法，可与 <code>webpack_require</code> 加载本地脚本进行对比。</p>
<p><img src="/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220925-195651.png"></p>
<p>这里遍历执行 <code>webpack_require.f</code> 里面的方法并收集返回的 <code>promise</code>，当所有的 <code>promise</code> 都完成时意味着这个远程的模块已经加载到内存里面了，注册进 <code>webpack_modules</code> 这个全局模块缓冲池里面了。</p>
<p><img src="/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/20220925-200036.png"></p>
<h4 id="与其他共享代码方案比较"><a href="#与其他共享代码方案比较" class="headerlink" title="与其他共享代码方案比较"></a>与其他共享代码方案比较</h4><p>module两种，本地构建的模块(local module)、运行时容器加载的远程模块(remote module)。<br> 模块联邦并没有样式隔离机制, 这意味着, 当主子应用很有可能会互相造成样式污染.<br>但缺点公用全局变量和全局style，以及将模块暴露在全局变量下不够优雅。<br>让代码直接在项目间利用 CDN 直接共享<br>比如我们在开发两个应用A和B，A应用需要引用B应用，假设这两个应用是两个人开发的，都处于开发阶段，那么这时候就可以通过webpack的模块联邦Module Federation，将B应用暴露出去，然后A应用引用B应用。这样就不需要每次B应用build完了给A，直接可以同步开发。</p>
<p>使用模块联邦，每个应用块都应该是一个独立的构建，这些构建都将编译成容器，容器可以被其他应用或容器使用，引用模块的引用者成为host，一个被引用的容器成为remote。</p>
<p>有点类似微前端，其实微前端方案中确实也有模块联邦的方案。</p>
<p><strong>NPM</strong><br>你有一个组件包通过npm发布后，你的10个业务项目引用这个组件包。当这个组件包更新了版本，你的10个项目想要使用最新功能就必须一一升级版本、编译打包、部署，这很繁琐。但是模块联邦让组件包利用CDN的方式共享给其他项目，这样一来，当你到组件包更新了，你的10个项目中的组件也自然更新了。是不是很香(<em>^▽^</em>)<br>维护一个 CommonComponents 的 NPM 包，在不同项目中安装、使用。如果 NPM 包升级，对应项目都需要安装新版本，本地编译，打包到 bundle 中。<br><strong>UMD</strong><br>即Universal Module Definition（通用模块规范），基本原理是利用设计模式中的工厂函数来统一不同的模块定义规范。<br>类似于我们开发的时候，经常会把某些功能封装成可复用的模块。并且对外暴露一个API，比如jquery、lodash等这类第三方插件，也可以通过CND的方式直接应用。后续这个公共函数的升级改造，我们更新CND引用链接地址，应用就自然也更新了。<br>UMD 优点在 runtime。缺点也明显，体积优化不方便，容易有版本冲突。</p>
<p><strong>微前端</strong><br>独立应用间的共享也是问题。一般有两种打包方式：</p>
<p>子应用独立打包，模块解耦了，但公共的依赖不易维护处理</p>
<p>整体应用一起打包，能解决公共依赖；但庞大的多个项目又使打包变慢，后续也不好扩展<br>插拔式的热更新</p>
<p>从图中可以看到，这个方案是直接将一个应用的 bundle，应用于另一个应用。<br>应用可以模块化输出，就是说它本身可以自我消费，也可以动态分发 runtime 子模块给其他应用</p>
<p>。<br>试想一下，你有一个组件包通过npm发布后，你的10个业务项目引用这个组件包。当这个组件包更新了版本，你的10个项目想要使用最新功能就必须一一升级版本、编译打包、部署，这很繁琐。但是模块联邦让组件包利用CDN的方式共享给其他项目，这样一来，当你到组件包更新了，你的10个项目中的组件也自然更新了。是不是很香(<em>^▽^</em>)</p>
<p>大部分子应用都依赖的资源怎么处理<br>模块联邦可以去依赖一个远程模块，这个依赖会在运行时生效，并不影响编译时。因此，这个远程依赖的模块就可以是一个微前端独立模块。同时，每个独立模块都可以申明公共的依赖库，这样也可以避免独立模块间的依赖包的冗余和冲突。<br>在shared中可以定义依赖的公共库，这个例子就是rxjs。这样就可以保证整个应用仅仅会加载rxjs库一次，否则的话公共库会被打包进入宿主应用，同时也会在各个子模块中重复出现。</p>
<p>当然，shared的公共库需要保证是一样的版本。</p>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="https://nevvvver.github.io/2022/09/15/webpack5%E6%96%B0%E7%89%B9%E6%80%A7/" title="webpack5新特性" target="_blank" rel="external">https://nevvvver.github.io/2022/09/15/webpack5新特性/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://github.com/Nevvvver" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar.jpg" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://github.com/Nevvvver" target="_blank"><span class="text-dark">Never</span><small class="ml-1x">Web Developer &amp; Sunday painter</small></a></h3>
        <div>Never worried, Never mind.</div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    
  <section id="comments">
  	
      <div id="vcomments"></div>
    
  </section>


  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    
    <li class="next">
      <a href="/2022/07/13/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BANodeJS/" title="《深入浅出Node.js》笔记"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
    <li class="toggle-toc">
      <a class="toggle-btn " data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button">    <span>[&nbsp;</span><span>文章目录</span>
        <i class="text-collapsed icon icon-anchor"></i>
        <i class="text-in icon icon-close"></i>
        <span>]</span>
      </a>
    </li>
    
  </ul>
  
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div>
    
  </div>
  </div>
</nav>
  


</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/Nevvvver" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="/null" target="_blank" title="Weibo" data-toggle=tooltip data-placement=top><i class="icon icon-weibo"></i></a></li>
        
        <li><a href="/null" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
        	Theme by <a href="https://github.com/cofess" target="_blank"> cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.
        </div>
    </div>
</footer>
  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>




    <script>
  $('.highlight').each(function (i, e) {
    var $wrap = $('<div>').addClass('highlight-wrap')
    $(e).after($wrap)

     var text= $(e).find('figcaption').find('span').text()
    var fields = text.match(/operation/g);
  if(fields){
$wrap.append($('<i title="运行"></i>').addClass('icon icon-angle-right operation').on('click', function (e) {
  var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text()
        }).toArray().join('\n')
  new Function(code)();
}))
}

    $wrap.append($('<button>').addClass('copy-btn').append('Copy').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text()
        }).toArray().join('\n')
        var ta = document.createElement('textarea')
        document.body.appendChild(ta)
        ta.style.position = 'absolute'
        ta.style.top = '0px'
        ta.style.left = '0px'
        ta.value = code
        ta.select()
        ta.focus()
        var result = document.execCommand('copy')
        document.body.removeChild(ta)
        
          if(result)$(this).text('Copied')
          else $(this).text('Copy failed')
        
        $(this).blur()
    })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn')
        setTimeout(function () {
          $b.text('Copy')
        }, 300)
    }).append(e)
  })
  
</script>

<script>
    $('.highlight').each(function (i, e) {
    var $wrap = $('<div>').addClass('highlight-wrap')

    var text= $(e).find('figcaption').find('span').text()
    var fields = text.match(/\{[\w,-]+\}/g);
    
    if(fields && fields.length === 1){
        fields[0] = fields[0].slice(1, -1);
        var elements = fields[0].split(',');
        var lineNumbers = []

        elements.map((ele)=>{
            var values = ele.split('-')
            if(values.length === 1){ lineNumbers.push(Number(ele)); }
            else {
                for(var j=Number(values[0]); j<= Number(values[1]) ; j++){
                    lineNumbers.push(Number(j))
                }
            }
        })
        
        $(e).find('pre').eq(1).children('span').each(function(i,e){
            if(lineNumbers.includes(i+1)){
            $(e).addClass('line-highlight')
            }
        })
    }
    })
</script>



   




   
    
  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/valine"></script>
  <script type="text/javascript">
  var GUEST = ['nick', 'mail', 'link'];
  var meta = 'nick,mail,link';
  meta = meta.split(',').filter(function(item) {
    return GUEST.indexOf(item) > -1;
  });
  new Valine({
    el: '#vcomments',
    verify: false,
    notify: false,
    appId: 'Ptdp2i9mmWrGF9nq9nbtpgIG-gzGzoHsz',
    appKey: '7wtwhNMvPTwOwiqlYYsJzCTm',
    placeholder: 'Just go go',
    avatar: 'mm',
    meta: meta,
    pageSize: '10' || 10,
    visitor: false
  });
  </script>

     









    
  <script>
    (function(d, w, c) {
      w.ChatraID = 'FaTbsFnnNTkNfR62N';
      var s = d.createElement('script');
      w[c] = w[c] || function() {
        (w[c].q = w[c].q || []).push(arguments);
      };
      s.async = true;
      s.src = 'https://call.chatra.io/chatra.js';
      if (d.head) d.head.appendChild(s);
    })(document, window, 'Chatra');
  </script>
 
 
</body>
</html>